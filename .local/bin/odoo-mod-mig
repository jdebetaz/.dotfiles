#!/usr/bin/env bash

set -e

if [ "$#" -ne 3 ]; then
  echo "Usage: $0 <module> <from_version> <to_version>"
  exit 1
fi

MODULE="$1"
FROM_VERSION="$2"
TO_VERSION="$3"

BRANCH="${TO_VERSION}-mig-${MODULE}"

echo "▶ Creating migration branch ${BRANCH}"
git checkout -b "${BRANCH}" "origin/${TO_VERSION}"

echo "▶ Applying patches for module ${MODULE} (${FROM_VERSION} → ${TO_VERSION})"
git format-patch \
  --keep-subject \
  --stdout \
  "origin/${TO_VERSION}..origin/${FROM_VERSION}" \
  -- "${MODULE}" \
| git am -3 --keep

echo "▶ Running pre-commit (pylint errors can be ignored)"
pre-commit run -a || true

echo "▶ Committing pre-commit auto fixes"
git add -A
git commit -m "[IMP] ${MODULE}: pre-commit auto fixes" --no-verify

echo "✅ Done"
echo "Branch: ${BRANCH}"

